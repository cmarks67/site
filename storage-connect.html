<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Warehouse Intelligence – Connections</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Force HTTPS -->
  <script>
    if (location.protocol === "http:") {
      location.replace("https://" + location.host + location.pathname + location.search + location.hash);
    }
  </script>

  <style>
    :root{
      --wi-red:#dc2626; --wi-red-dark:#b91c1c;
      --bg:#f3f4f6; --card:#fff; --border:#e5e7eb;
      --text:#111827; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
    .brand{font-weight:800;font-size:1.2rem}
    .brand span{color:var(--wi-red)}
    .topbar{display:flex;align-items:center;justify-content:space-between}
    .btn{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:600}
    .btnPrimary{background:var(--wi-red);color:#fff;border:none}
    .btnPrimary:hover{background:var(--wi-red-dark)}
    main .wrap{padding:22px 18px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    .tile{border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;align-items:center;gap:12px}
    .icon{width:48px;height:48px;border-radius:12px;display:grid;place-items:center;background:#f9fafb;border:1px solid var(--border)}
    .right{margin-left:auto;display:flex;flex-direction:column;gap:6px}
    .pill{font-size:.75rem;border-radius:999px;padding:3px 8px;border:1px solid var(--border)}
    .pill.on{background:#dcfce7;color:#166534}
    .pill.off{background:#fee2e2;color:#991b1b}
    .warn{background:#fffbeb;border:1px solid #fde68a;border-radius:12px;padding:12px}
  </style>

  <!-- MSAL loader (robust, non-fatal) -->
  <script>
    (function () {
      function load(src, ok, bad) {
        var s = document.createElement("script");
        s.src = src;
        s.defer = true;
        s.onload = ok;
        s.onerror = bad;
        document.head.appendChild(s);
      }

      load(
        "https://unpkg.com/@azure/msal-browser@2.39.0/dist/msal-browser.min.js",
        function(){ console.log("MSAL loaded (unpkg)"); },
        function(){
          console.warn("MSAL failed (unpkg), trying jsDelivr");
          load(
            "https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.39.0/dist/msal-browser.min.js",
            function(){ console.log("MSAL loaded (jsDelivr)"); },
            function(){ console.error("MSAL failed to load"); }
          );
        }
      );
    })();
  </script>
</head>

<body>
<header>
  <div class="wrap topbar">
    <div class="brand">Warehouse <span>Intelligence</span></div>
    <a class="btn" href="dashboard.html">Back to dashboard</a>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="card">
      <h1>Connections</h1>

      <div id="statusBox" class="warn">
        <div id="statusText">Initialising…</div>
      </div>

      <div class="grid" style="margin-top:14px">

        <!-- Dropbox -->
        <div class="tile">
          <div class="icon">DB</div>
          <div>
            <strong>Dropbox</strong><br/>
            OAuth sign-in
          </div>
          <div class="right">
            <span id="pillDropbox" class="pill off">Not connected</span>
            <button id="dbConnect" class="btnPrimary">Connect</button>
            <button id="dbTest" class="btn">Test</button>
          </div>
        </div>

        <!-- OneDrive -->
        <div class="tile">
          <div class="icon">OD</div>
          <div>
            <strong>OneDrive</strong><br/>
            MSAL + Graph
          </div>
          <div class="right">
            <span id="pillOD" class="pill off">Unavailable</span>
            <button id="odConnect" class="btnPrimary" disabled>Connect</button>
            <button id="odTest" class="btn" disabled>Test</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</main>

<script>
/* =========================
   SAFE CORE LOGIC
========================= */
const DROPBOX_APP_KEY = "k8fsr7ttwve6k8m";
const DROPBOX_REDIRECT = location.origin + location.pathname;

const status = msg => document.getElementById("statusText").innerHTML = msg;

/* ---------- Dropbox ---------- */
document.getElementById("dbConnect").onclick = () => {
  location.href =
    "https://www.dropbox.com/oauth2/authorize" +
    "?client_id=" + DROPBOX_APP_KEY +
    "&response_type=token" +
    "&redirect_uri=" + encodeURIComponent(DROPBOX_REDIRECT);
};

document.getElementById("dbTest").onclick = () => {
  alert("Dropbox JS active – OAuth redirect will confirm token.");
};

/* ---------- OneDrive (guarded) ---------- */
function enableOneDrive() {
  document.getElementById("pillOD").textContent = "Ready";
  document.getElementById("pillOD").className = "pill on";
  document.getElementById("odConnect").disabled = false;
  document.getElementById("odTest").disabled = false;
}

function waitForMsal(max=8000){
  return new Promise(res=>{
    const start=Date.now();
    const t=setInterval(()=>{
      if(window.msal && msal.PublicClientApplication){
        clearInterval(t); res(true);
      }
      if(Date.now()-start>max){
        clearInterval(t); res(false);
      }
    },100);
  });
}

(async()=>{
  status("Checking OneDrive availability…");
  const ok = await waitForMsal();
  if(!ok){
    status("OneDrive unavailable (MSAL blocked). Dropbox is fully functional.");
    return;
  }

  enableOneDrive();

  const msalApp = new msal.PublicClientApplication({
    auth:{
      clientId:"861977dd-6e5a-46ab-a3c8-edfd6098a741",
      authority:"https://login.microsoftonline.com/consumers",
      redirectUri:location.origin+location.pathname
    }
  });

  document.getElementById("odConnect").onclick = async ()=>{
    await msalApp.loginPopup({scopes:["User.Read","Files.ReadWrite"]});
    status("OneDrive connected successfully.");
  };

  document.getElementById("odTest").onclick = async ()=>{
    const acc = msalApp.getAllAccounts()[0];
    const tok = await msalApp.acquireTokenSilent({
      account:acc,
      scopes:["User.Read"]
    });
    alert("OneDrive OK. Token acquired.");
  };

})();
</script>
</body>
</html>
