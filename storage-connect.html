<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Warehouse Intelligence – Connections</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Force HTTPS on your live domain -->
  <script>
    if (location.hostname.endsWith("warehouseintelligence.co.uk") && location.protocol === "http:") {
      location.replace("https://" + location.host + location.pathname + location.search + location.hash);
    }
  </script>

  <style>
    :root{
      --wi-red:#dc2626; --wi-red-dark:#b91c1c;
      --bg:#f3f4f6; --card:#fff; --border:#e5e7eb;
      --text:#111827; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
    .brand{font-weight:800;font-size:1.2rem}
    .brand span{color:var(--wi-red)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .btn{
      display:inline-block;padding:10px 14px;border-radius:999px;
      border:1px solid var(--border);background:#fff;cursor:pointer;
      text-decoration:none;color:var(--text);font-weight:600;font-size:.9rem
    }
    .btn:hover{background:#f9fafb}
    .btnPrimary{background:var(--wi-red);border-color:transparent;color:#fff}
    .btnPrimary:hover{background:var(--wi-red-dark)}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    main .wrap{padding:22px 18px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      padding:18px;box-shadow:0 6px 16px rgba(0,0,0,.04);margin-bottom:16px
    }
    h1{margin:0 0 6px;font-size:1.35rem}
    .muted{color:var(--muted);font-size:.95rem;line-height:1.45}
    .grid{
      display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;margin-top:14px
    }
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 520px){ .grid{grid-template-columns:1fr} }
    .tile{
      border:1px solid var(--border);border-radius:14px;padding:14px;
      display:flex;gap:12px;align-items:center;background:#fff
    }
    .icon{
      width:52px;height:52px;border-radius:14px;display:grid;place-items:center;
      border:1px solid var(--border);background:#f9fafb;font-weight:800;color:var(--muted)
    }
    .tile h3{margin:0;font-size:1rem}
    .tile .muted{margin:3px 0 0;font-size:.85rem}
    .right{margin-left:auto;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .pill{
      font-size:.75rem;border:1px solid var(--border);border-radius:999px;padding:3px 8px;
      color:var(--muted);background:#fff
    }
    .pill.on{background:#dcfce7;border-color:#bbf7d0;color:#166534}
    .pill.off{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .pill.neutral{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
    .small{font-size:.85rem}
    .warn{background:#fffbeb;border-color:#fde68a}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  </style>

  <!-- MSAL (correct path for 2.39.0 is /lib/, not /dist/) -->
  <script src="https://unpkg.com/@azure/msal-browser@2.39.0/lib/msal-browser.min.js"></script>
</head>

<body>
<header>
  <div class="wrap topbar">
    <div class="brand">Warehouse <span>Intelligence</span></div>
    <div style="display:flex;gap:10px;align-items:center;">
      <a class="btn" href="dashboard.html">Back to dashboard</a>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="card">
      <h1>Connections</h1>
      <p class="muted">
        Choose where your schedules and KPI exports are saved. Connections are stored per user in this browser.
      </p>

      <div id="statusBox" class="card warn" style="margin-top:12px;">
        <div class="muted small" id="statusText">Loading status…</div>
      </div>

      <div class="grid">

        <!-- Dropbox -->
        <div class="tile">
          <div class="icon">DB</div>
          <div>
            <h3>Dropbox</h3>
            <div class="muted">OAuth sign-in, token saved locally</div>
          </div>
          <div class="right">
            <span id="pillDropbox" class="pill off">Not connected</span>
            <button id="btn-dropbox-connect" class="btn btnPrimary">Connect</button>
            <button id="btn-dropbox-test" class="btn small">Test</button>
            <button id="btn-dropbox-disconnect" class="btn small">Disconnect</button>
          </div>
        </div>

        <!-- OneDrive -->
        <div class="tile">
          <div class="icon">OD</div>
          <div>
            <h3>OneDrive</h3>
            <div class="muted">Microsoft sign-in (MSAL) + Graph</div>
          </div>
          <div class="right">
            <span id="pillOneDrive" class="pill off">Not connected</span>
            <button id="btn-onedrive-connect" class="btn btnPrimary">Connect</button>
            <button id="btn-onedrive-test" class="btn small">Test</button>
            <button id="btn-onedrive-disconnect" class="btn small">Disconnect</button>
          </div>
        </div>

        <!-- Azure (placeholder) -->
        <div class="tile">
          <div class="icon">AZ</div>
          <div>
            <h3>Azure</h3>
            <div class="muted">Planned</div>
          </div>
          <div class="right">
            <span class="pill neutral">Coming soon</span>
            <button class="btn" disabled>Connect</button>
            <button class="btn small" disabled>Test</button>
            <button class="btn small" disabled>Disconnect</button>
          </div>
        </div>

        <!-- Local folder (placeholder) -->
        <div class="tile">
          <div class="icon">PC</div>
          <div>
            <h3>Local folder</h3>
            <div class="muted">Browser folder picker (Chrome/Edge)</div>
          </div>
          <div class="right">
            <span id="pillLocal" class="pill off">Not connected</span>
            <button id="btn-local-connect" class="btn">Choose folder</button>
            <button id="btn-local-test" class="btn small">Test</button>
            <button id="btn-local-disconnect" class="btn small">Disconnect</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</main>

<script>
/* =========================
   Diagnostics (helps you prove buttons are wired)
========================= */
console.log("storage-connect.html loaded:", location.href);
document.addEventListener("click", (e) => {
  if (e.target && e.target.id) console.log("Clicked:", e.target.id);
});

/* =========================
   Storage keys
========================= */
const K_ACTIVE     = "wi_storage_active_v1";
const K_DB_TOKENS  = "wi_dropbox_tokens_v1";
const K_OD_TOKENS  = "wi_onedrive_tokens_v1";
const K_LOCAL      = "wi_local_folder_handle_v1";

/* =========================
   Your keys
========================= */
const DROPBOX_APP_KEY = "k8fsr7ttwve6k8m";
const AZURE_CLIENT_ID = "861977dd-6e5a-46ab-a3c8-edfd6098a741";

/* Redirect URI: must match what you registered in Dropbox + Entra */
const REDIRECT_URI = location.origin + location.pathname;

/* =========================
   Helpers
========================= */
function setActive(provider){ localStorage.setItem(K_ACTIVE, provider); }

function safeJSONParse(v){
  try { return JSON.parse(v); } catch { return null; }
}

function setStatus(msgHtml){
  document.getElementById("statusText").innerHTML = msgHtml;
}

function setPill(el, on, onText, offText){
  el.className = "pill " + (on ? "on" : "off");
  el.textContent = on ? onText : offText;
}

function msalAvailable(){
  return !!window.msal && !!window.msal.PublicClientApplication;
}

/* =========================
   Dropbox
========================= */
function handleDropboxReturn(){
  if (!location.hash || !location.hash.includes("access_token=")) return;
  const hash = new URLSearchParams(location.hash.slice(1));
  const accessToken = hash.get("access_token");
  if (accessToken) {
    localStorage.setItem(K_DB_TOKENS, JSON.stringify({
      access_token: accessToken,
      token_type: hash.get("token_type"),
      uid: hash.get("uid"),
      account_id: hash.get("account_id"),
      obtained_at: new Date().toISOString()
    }));
    setActive("dropbox");
  }
  history.replaceState({}, document.title, location.pathname);
}

function connectDropbox(){
  const authUrl =
    "https://www.dropbox.com/oauth2/authorize" +
    "?client_id=" + encodeURIComponent(DROPBOX_APP_KEY) +
    "&response_type=token" +
    "&redirect_uri=" + encodeURIComponent(REDIRECT_URI);

  window.location.href = authUrl;
}

async function testDropbox(){
  const tok = safeJSONParse(localStorage.getItem(K_DB_TOKENS));
  if (!tok?.access_token) { alert("Dropbox not connected yet."); return; }

  // Lightweight call: get current account
  const r = await fetch("https://api.dropboxapi.com/2/users/get_current_account", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + tok.access_token,
      "Content-Type": "application/json"
    }
  });

  if (!r.ok) {
    const t = await r.text();
    alert("Dropbox test failed:\n" + r.status + " " + t);
    return;
  }

  const data = await r.json();
  alert("Dropbox OK:\n" + (data?.name?.display_name || "Connected"));
}

function disconnectDropbox(){
  localStorage.removeItem(K_DB_TOKENS);
  if (localStorage.getItem(K_ACTIVE) === "dropbox") localStorage.setItem(K_ACTIVE, "(none)");
}

/* =========================
   OneDrive (MSAL + Graph)
========================= */
let msalApp = null;

function initOneDriveIfPossible(){
  if (!msalAvailable()) {
    // Do not break the page; just disable OneDrive actions
    document.getElementById("btn-onedrive-connect").disabled = true;
    document.getElementById("btn-onedrive-test").disabled = true;
    document.getElementById("btn-onedrive-disconnect").disabled = false; // allow clearing
    setPill(document.getElementById("pillOneDrive"), false, "Connected", "Unavailable (MSAL not loaded)");
    return;
  }

  msalApp = new msal.PublicClientApplication({
    auth: {
      clientId: AZURE_CLIENT_ID,
      authority: "https://login.microsoftonline.com/consumers",
      redirectUri: REDIRECT_URI
    },
    cache: {
      cacheLocation: "localStorage",
      storeAuthStateInCookie: false
    }
  });

  document.getElementById("btn-onedrive-connect").disabled = false;
  document.getElementById("btn-onedrive-test").disabled = false;
}

async function connectOneDrive(){
  if (!msalApp) { alert("OneDrive unavailable because MSAL did not load."); return; }

  const login = await msalApp.loginPopup({
    scopes: ["User.Read", "Files.ReadWrite"]
  });

  // Save a simple flag/token marker
  localStorage.setItem(K_OD_TOKENS, JSON.stringify({
    homeAccountId: login.account?.homeAccountId,
    username: login.account?.username,
    obtained_at: new Date().toISOString()
  }));
  setActive("onedrive");
  refreshUI();
  alert("OneDrive sign-in completed.");
}

async function getGraphToken(){
  const accounts = msalApp.getAllAccounts();
  const account = accounts && accounts[0];
  if (!account) throw new Error("No signed-in account found.");

  const token = await msalApp.acquireTokenSilent({
    account,
    scopes: ["User.Read", "Files.ReadWrite"]
  });

  return token.accessToken;
}

async function testOneDrive(){
  if (!msalApp) { alert("OneDrive unavailable because MSAL did not load."); return; }

  try {
    const token = await getGraphToken();
    const r = await fetch("https://graph.microsoft.com/v1.0/me", {
      headers: { "Authorization": "Bearer " + token }
    });

    if (!r.ok) {
      const t = await r.text();
      alert("OneDrive test failed:\n" + r.status + " " + t);
      return;
    }

    const me = await r.json();
    alert("OneDrive OK:\n" + (me.displayName || me.userPrincipalName || "Connected"));
  } catch (e) {
    alert("OneDrive test error:\n" + (e?.message || String(e)));
  }
}

function disconnectOneDrive(){
  localStorage.removeItem(K_OD_TOKENS);
  if (localStorage.getItem(K_ACTIVE) === "onedrive") localStorage.setItem(K_ACTIVE, "(none)");
  refreshUI();
}

/* =========================
   Local folder (placeholder)
========================= */
function connectLocal(){
  alert("Local folder picker not implemented yet. (Requires File System Access API).");
}
function testLocal(){
  alert("Local folder test not implemented yet.");
}
function disconnectLocal(){
  localStorage.removeItem(K_LOCAL);
  if (localStorage.getItem(K_ACTIVE) === "local") localStorage.setItem(K_ACTIVE, "(none)");
  refreshUI();
}

/* =========================
   UI refresh
========================= */
function refreshUI(){
  const pillDropbox = document.getElementById("pillDropbox");
  const pillOneDrive = document.getElementById("pillOneDrive");
  const pillLocal = document.getElementById("pillLocal");

  const db = !!localStorage.getItem(K_DB_TOKENS);
  const od = !!localStorage.getItem(K_OD_TOKENS);
  const lf = !!localStorage.getItem(K_LOCAL);

  setPill(pillDropbox, db, "Connected", "Not connected");
  setPill(pillOneDrive, od, "Connected", msalAvailable() ? "Not connected" : "Unavailable (MSAL not loaded)");
  setPill(pillLocal, lf, "Connected", "Not connected");

  const active = localStorage.getItem(K_ACTIVE) || "(none)";
  setStatus(`
    <div><strong>Active:</strong> ${active}</div>
    <div class="muted small" style="margin-top:6px;">
      Page URL: <code>${location.href}</code>
    </div>
    <div class="muted small" style="margin-top:6px;">
      Redirect URI in use: <code>${REDIRECT_URI}</code>
    </div>
    <div class="muted small" style="margin-top:6px;">
      MSAL loaded: <code>${msalAvailable() ? "YES" : "NO"}</code>
    </div>
  `);
}

/* =========================
   Wire buttons (Dropbox must always wire)
========================= */
document.getElementById("btn-dropbox-connect").addEventListener("click", connectDropbox);
document.getElementById("btn-dropbox-test").addEventListener("click", testDropbox);
document.getElementById("btn-dropbox-disconnect").addEventListener("click", () => { disconnectDropbox(); refreshUI(); });

document.getElementById("btn-onedrive-connect").addEventListener("click", connectOneDrive);
document.getElementById("btn-onedrive-test").addEventListener("click", testOneDrive);
document.getElementById("btn-onedrive-disconnect").addEventListener("click", disconnectOneDrive);

document.getElementById("btn-local-connect").addEventListener("click", connectLocal);
document.getElementById("btn-local-test").addEventListener("click", testLocal);
document.getElementById("btn-local-disconnect").addEventListener("click", disconnectLocal);

/* =========================
   Init
========================= */
handleDropboxReturn();
initOneDriveIfPossible();
refreshUI();
</script>

</body>
</html>
