<!doctype html>
<html lang="en">
<head>

<script>
  (function () {
    if (location.protocol === "http:") {
      location.replace("https://" + location.host + location.pathname + location.search + location.hash);
    }
  })();
</script>



  <meta charset="utf-8" />
  <title>Warehouse Intelligence – Connections</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --wi-red:#dc2626; --wi-red-dark:#b91c1c;
      --bg:#f3f4f6; --card:#fff; --border:#e5e7eb;
      --text:#111827; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
    .brand{font-weight:800;font-size:1.2rem}
    .brand span{color:var(--wi-red)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .btn{
      display:inline-block;padding:10px 14px;border-radius:999px;
      border:1px solid var(--border);background:#fff;cursor:pointer;
      text-decoration:none;color:var(--text);font-weight:600;font-size:.9rem
    }
    .btn:hover{background:#f9fafb}
    .btnPrimary{background:var(--wi-red);border-color:transparent;color:#fff}
    .btnPrimary:hover{background:var(--wi-red-dark)}
    main .wrap{padding:22px 18px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      padding:18px;box-shadow:0 6px 16px rgba(0,0,0,.04);margin-bottom:16px
    }
    h1{margin:0 0 6px;font-size:1.35rem}
    .muted{color:var(--muted);font-size:.95rem;line-height:1.45}
    .grid{
      display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;margin-top:14px
    }
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 520px){ .grid{grid-template-columns:1fr} }
    .tile{
      border:1px solid var(--border);border-radius:14px;padding:14px;
      display:flex;gap:12px;align-items:center;background:#fff
    }
    .icon{
      width:52px;height:52px;border-radius:14px;display:grid;place-items:center;
      border:1px solid var(--border);background:#f9fafb;font-weight:800;color:var(--muted)
    }
    .tile h3{margin:0;font-size:1rem}
    .tile .muted{margin:3px 0 0;font-size:.85rem}
    .right{margin-left:auto;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .pill{
      font-size:.75rem;border:1px solid var(--border);border-radius:999px;padding:3px 8px;
      color:var(--muted);background:#fff
    }
    .pill.on{background:#dcfce7;border-color:#bbf7d0;color:#166534}
    .pill.off{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .small{font-size:.85rem}
    .warn{background:#fffbeb;border-color:#fde68a}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  </style>
</head>
<body>

<header>
  <div class="wrap topbar">
    <div class="brand">Warehouse <span>Intelligence</span></div>
    <div style="display:flex;gap:10px;align-items:center;">
      <a class="btn" href="dashboard.html">Back to dashboard</a>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <div class="card">
      <h1>Connections</h1>
      <p class="muted">
        Choose where your schedules and KPI exports are saved. Connections are stored per user in this browser.
        You will be redirected to sign in with the provider when you click connect.
      </p>

      <div id="statusBox" class="card warn" style="margin-top:12px;">
        <div class="muted small" id="statusText">Loading status…</div>
      </div>

      <div class="grid" style="margin-top:14px;">

        <!-- Dropbox -->
        <div class="tile">
          <div class="icon">DB</div>
          <div>
            <h3>Dropbox</h3>
            <div class="muted">OAuth sign-in, token saved locally</div>
          </div>
          <div class="right">
            <span id="pillDropbox" class="pill off">Not connected</span>
            <button id="btn-dropbox-connect" class="btn btnPrimary">Connect</button>
            <button id="btn-dropbox-test" class="btn small">Test</button>
            <button id="btn-dropbox-disconnect" class="btn small">Disconnect</button>
          </div>
        </div>

        <!-- OneDrive -->
        <div class="tile">
          <div class="icon">OD</div>
          <div>
            <h3>OneDrive</h3>
            <div class="muted">Microsoft sign-in (MSAL) + Graph</div>
          </div>
          <div class="right">
            <span id="pillOneDrive" class="pill off">Not connected</span>
            <button id="btn-onedrive-connect" class="btn btnPrimary">Connect</button>
            <button id="btn-onedrive-test" class="btn small">Test</button>
            <button id="btn-onedrive-disconnect" class="btn small">Disconnect</button>
          </div>
        </div>

        <!-- Azure (placeholder) -->
        <div class="tile">
          <div class="icon">AZ</div>
          <div>
            <h3>Azure</h3>
            <div class="muted">Planned</div>
          </div>
          <div class="right">
            <span class="pill">Coming soon</span>
            <button class="btn" disabled>Connect</button>
          </div>
        </div>

        <!-- Local folder (placeholder) -->
        <div class="tile">
          <div class="icon">PC</div>
          <div>
            <h3>Local folder</h3>
            <div class="muted">Browser folder picker (Chrome/Edge)</div>
          </div>
          <div class="right">
            <span id="pillLocal" class="pill off">Not connected</span>
            <button id="btn-local-connect" class="btn">Choose folder</button>
          </div>
        </div>

      </div>
    </div>

  </div>
</main>

<!-- MSAL (Microsoft Authentication Library) -->
<script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@3/dist/msal-browser.min.js"></script>

<script>
(() => {
  "use strict";

  console.log("storage-connect.html script loaded (boot)");

  /* =========================
     Storage keys
  ========================= */
  const K_ACTIVE    = "wi_storage_active_v1";
  const K_DB_TOKENS = "wi_dropbox_tokens_v1";
  const K_OD_FLAG   = "wi_onedrive_flag_v1";
  const K_LOCAL     = "wi_local_folder_handle_v1";

  /* =========================
     Dropbox config
  ========================= */
  const DROPBOX_APP_KEY = "k8fsr7ttwve6k8m";
  const DROPBOX_REDIRECT_URI =
    (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:5500/storage-connect.html"
      : "https://warehouseintelligence.co.uk/storage-connect.html";

  /* =========================
     OneDrive (MSAL) config
  ========================= */
  const ONEDRIVE_CLIENT_ID = "861977dd-6e5a-46ab-a3c8-edfd6098a741";

  const msalConfig = {
    auth: {
      clientId: ONEDRIVE_CLIENT_ID,
      authority: "https://login.microsoftonline.com/consumers",
      redirectUri: location.origin + location.pathname
    },
    cache: {
      cacheLocation: "localStorage",
      storeAuthStateInCookie: false
    }
  };

  const odLoginRequest = { scopes: ["User.Read", "Files.Read"] };
  const msalInstance = new msal.PublicClientApplication(msalConfig);

  // Safe to call even when using popup (helps if MSAL ever returns via redirect)
  msalInstance.handleRedirectPromise().catch(err => console.warn("MSAL redirect handling:", err));

  function setActive(provider) {
    localStorage.setItem(K_ACTIVE, provider);
  }

  function setStatus() {
    const pillDropbox = document.getElementById("pillDropbox");
    const pillOneDrive = document.getElementById("pillOneDrive");
    const pillLocal = document.getElementById("pillLocal");
    const statusText = document.getElementById("statusText");

    const db = !!localStorage.getItem(K_DB_TOKENS);
    const od = (msalInstance.getAllAccounts().length > 0) || !!localStorage.getItem(K_OD_FLAG);
    const lf = !!localStorage.getItem(K_LOCAL);

    pillDropbox.className = "pill " + (db ? "on" : "off");
    pillDropbox.textContent = db ? "Connected" : "Not connected";

    pillOneDrive.className = "pill " + (od ? "on" : "off");
    pillOneDrive.textContent = od ? "Connected" : "Not connected";

    pillLocal.className = "pill " + (lf ? "on" : "off");
    pillLocal.textContent = lf ? "Connected" : "Not connected";

    const active = localStorage.getItem(K_ACTIVE) || "(none)";
    statusText.innerHTML = `
      <div><strong>Active:</strong> ${active}</div>
      <div class="muted small" style="margin-top:6px;">
        Dropbox Redirect URI: <code>${DROPBOX_REDIRECT_URI}</code>
      </div>
      <div class="muted small" style="margin-top:6px;">
        OneDrive Redirect URI: <code>${location.origin + location.pathname}</code>
      </div>
      <div class="muted small" style="margin-top:6px;">
        Tip: Use <code>https://</code> for OneDrive/MSAL. Avoid <code>file:///</code>.
      </div>
    `;
  }

  /* =========================
     Dropbox (implicit)
  ========================= */
  function handleDropboxReturn() {
    if (!location.hash || !location.hash.includes("access_token=")) return;

    const hash = new URLSearchParams(location.hash.slice(1));
    const accessToken = hash.get("access_token");
    const tokenType = hash.get("token_type");
    const uid = hash.get("uid");
    const accountId = hash.get("account_id");

    if (accessToken) {
      localStorage.setItem(K_DB_TOKENS, JSON.stringify({
        access_token: accessToken,
        token_type: tokenType,
        uid,
        account_id: accountId,
        obtained_at: new Date().toISOString()
      }));
      setActive("dropbox");
    }

    history.replaceState({}, document.title, location.pathname);
  }

  function connectDropbox() {
    const authUrl =
      "https://www.dropbox.com/oauth2/authorize" +
      "?client_id=" + encodeURIComponent(DROPBOX_APP_KEY) +
      "&response_type=token" +
      "&redirect_uri=" + encodeURIComponent(DROPBOX_REDIRECT_URI);

    window.location.href = authUrl;
  }

  function disconnectDropbox() {
    localStorage.removeItem(K_DB_TOKENS);
    if (localStorage.getItem(K_ACTIVE) === "dropbox") localStorage.setItem(K_ACTIVE, "(none)");
    setStatus();
    alert("Dropbox disconnected.");
  }

  async function testDropbox() {
    const raw = localStorage.getItem(K_DB_TOKENS);
    if (!raw) {
      alert("Dropbox not connected. Click Connect first.");
      return;
    }
    let tok;
    try {
      tok = JSON.parse(raw);
    } catch {
      alert("Dropbox token data is invalid. Disconnect and reconnect Dropbox.");
      return;
    }

    const accessToken = tok?.access_token;
    if (!accessToken) {
      alert("Dropbox access token missing. Disconnect and reconnect Dropbox.");
      return;
    }

    // Simple “does token work” test: get current account info
    try {
      const resp = await fetch("https://api.dropboxapi.com/2/users/get_current_account", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: "null"
      });
      const data = await resp.json();

      if (!resp.ok) {
        console.error("Dropbox test error:", data);
        alert("Dropbox test failed: " + (data?.error_summary || resp.statusText));
        return;
      }

      const email = data?.email || "(no email)";
      const name = data?.name?.display_name || "(no name)";
      alert("Dropbox OK.\nName: " + name + "\nEmail: " + email);
    } catch (e) {
      console.error(e);
      alert("Dropbox test failed: " + (e?.message || String(e)));
    }
  }

  /* =========================
     OneDrive (MSAL + Graph)
  ========================= */
  async function odEnsureAccount() {
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length) {
      msalInstance.setActiveAccount(accounts[0]);
      return accounts[0];
    }
    return null;
  }

  async function odAcquireToken() {
    const account = await odEnsureAccount();
    if (!account) throw new Error("No signed-in Microsoft account. Click OneDrive Connect first.");
    try {
      return await msalInstance.acquireTokenSilent({ ...odLoginRequest, account });
    } catch {
      return await msalInstance.acquireTokenPopup(odLoginRequest);
    }
  }

  async function connectOneDrive() {
    try {
      const result = await msalInstance.loginPopup(odLoginRequest);
      msalInstance.setActiveAccount(result.account);

      localStorage.setItem(K_OD_FLAG, "1");
      setActive("onedrive");
      setStatus();

      alert("OneDrive connected as: " + (result.account?.username || "Microsoft user"));
    } catch (e) {
      console.error("OneDrive login failed:", e);
      alert("OneDrive sign-in failed: " + (e?.message || String(e)));
    }
  }

  async function testOneDrive() {
    try {
      const token = await odAcquireToken();
      const resp = await fetch("https://graph.microsoft.com/v1.0/me/drive/root/children?$top=10", {
        headers: { Authorization: "Bearer " + token.accessToken }
      });
      const data = await resp.json();

      if (!resp.ok) {
        console.error("Graph error:", data);
        alert("OneDrive test failed: " + (data?.error?.message || resp.statusText));
        return;
      }

      const names = (data.value || []).map(x => x.name).slice(0, 10);
      alert(names.length ? ("OneDrive OK. Top items:\n- " + names.join("\n- ")) : "OneDrive OK (no items returned).");
    } catch (e) {
      console.error("OneDrive test failed:", e);
      alert("OneDrive test failed: " + (e?.message || String(e)));
    }
  }

  async function disconnectOneDrive() {
    try {
      const account = await odEnsureAccount();
      if (account) await msalInstance.logoutPopup({ account });

      localStorage.removeItem(K_OD_FLAG);
      if (localStorage.getItem(K_ACTIVE) === "onedrive") localStorage.setItem(K_ACTIVE, "(none)");
      setStatus();

      alert("OneDrive disconnected.");
    } catch (e) {
      console.error("OneDrive logout failed:", e);
      alert("OneDrive disconnect failed: " + (e?.message || String(e)));
    }
  }

  /* =========================
     Local folder (placeholder)
  ========================= */
  function connectLocalFolder() {
    alert("Local folder picker can be implemented next (Chrome/Edge Folder Picker API).");
  }

  /* =========================
     Wire buttons (guarded)
  ========================= */
  document.getElementById("btn-dropbox-connect")?.addEventListener("click", connectDropbox);
  document.getElementById("btn-dropbox-test")?.addEventListener("click", testDropbox);
  document.getElementById("btn-dropbox-disconnect")?.addEventListener("click", disconnectDropbox);

  document.getElementById("btn-onedrive-connect")?.addEventListener("click", connectOneDrive);
  document.getElementById("btn-onedrive-test")?.addEventListener("click", testOneDrive);
  document.getElementById("btn-onedrive-disconnect")?.addEventListener("click", disconnectOneDrive);

  document.getElementById("btn-local-connect")?.addEventListener("click", connectLocalFolder);

  /* =========================
     Init
  ========================= */
  handleDropboxReturn();
  setStatus();
})();
</script>

</body>
</html>
