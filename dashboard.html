<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Warehouse Intelligence â€“ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 12px 20px;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #020617;
    }

    header .brand {
      font-weight: 600;
      font-size: 1rem;
    }

    header .brand span {
      color: #dc2626;
    }

    header .user-info {
      font-size: 0.85rem;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    header button {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.8rem;
    }

    main {
      flex: 1;
      padding: 16px 20px 28px;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
    }

    .layout {
      display: flex;
      gap: 24px;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 12px 10px;
      height: fit-content;
    }

    .sidebar-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 7px 9px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #e5e7eb;
      margin-bottom: 4px;
      user-select: none;
    }

    .nav-item.active {
      background: #1f2937;
    }

    .nav-item:hover {
      background: #111827;
    }

    /* Content area */
    .content {
      flex: 1;
    }

    .card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 16px 18px;
      margin-bottom: 20px;
    }

    h2 {
      font-size: 1.15rem;
      margin-bottom: 12px;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 0.75rem;
      margin-right: 6px;
    }

    .badge.admin {
      border-color: #f87171;
      color: #fecaca;
    }

    .badge.standard {
      border-color: #60a5fa;
      color: #bfdbfe;
    }

    .badge.business {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .badge.single_user {
      border-color: #a855f7;
      color: #e9d5ff;
    }

    .muted {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .hidden { display: none; }

    .btn-primary {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #dc2626;
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      margin-top: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 10px;
    }
    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 6px 4px;
      text-align: left;
    }
    th {
      color: #9ca3af;
      font-weight: 500;
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #d1d5db;
    }

    input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
      margin-bottom: 10px;
      box-sizing: border-box;
    }

    .btn-small {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #022c22;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
    }

    .error {
      color: #fecaca;
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .success {
      color: #bbf7d0;
      font-size: 0.8rem;
      margin-top: 6px;
    }
  </style>
</head>

<body>

  <header>
    <div class="brand">Warehouse <span>Intelligence</span></div>
    <div class="user-info">
      <span id="header-user-email"></span>
      <button id="btn-signout">Sign out</button>
    </div>
  </header>

  <main>
    <div class="layout">

      <!-- LEFT SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-title">Navigation</div>
        <div id="nav-overview" class="nav-item active">Overview</div>
        <div id="nav-users" class="nav-item">Users</div>
      </aside>

      <!-- MAIN CONTENT -->
      <section class="content">

        <!-- Account Card -->
        <div class="card" id="account-card">
          <h2>Account</h2>
          <div class="muted" id="account-name"></div>
          <div style="margin-top:6px;">
            <span id="badge-role" class="badge"></span>
            <span id="badge-account-type" class="badge"></span>
          </div>
        </div>

        <!-- Overview Section -->
        <section id="section-overview">
          <div class="card">
            <h2>Scheduling tool</h2>
            <p class="muted">
              Open your live scheduling tool. All entries are stored against your business account.
            </p>
            <a href="warehouse_scheduling.html" class="btn-primary">Open scheduling tool</a>
          </div>
        </section>

        <!-- Users Section -->
        <section id="section-users" class="hidden">

          <div class="card">
            <h2>Users</h2>
            <p class="muted" id="users-intro"></p>

            <div id="users-list-container" class="hidden">
              <table>
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
              </table>
            </div>

            <div id="single-user-note" class="hidden">
              <p class="muted">
                This is a <strong>Single-user</strong> account.  
                Additional users cannot be added.
              </p>
            </div>

            <div id="add-user-card" class="hidden" style="margin-top:14px; border-top:1px solid #1f2937; padding-top:12px;">
              <h3 style="font-size:0.95rem; margin:0 0 8px;">Add a standard user</h3>
              <form id="add-user-form">
                <label for="new-user-name">Full name</label>
                <input id="new-user-name" required />

                <label for="new-user-email">Email</label>
                <input id="new-user-email" type="email" required />

                <label for="new-user-password">Password</label>
                <input id="new-user-password" type="password" required />

                <label for="new-user-password-confirm">Confirm password</label>
                <input id="new-user-password-confirm" type="password" required />

                <button class="btn-small" id="btn-add-user" type="submit">Create user</button>
              </form>
              <div id="add-user-message"></div>
            </div>

          </div>
        </section>
      </section>

    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://lwsddsbizqwsdmrcgnwm.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_otgRLtgXtaZgj-c2pxov1A_SQBpaxVB";

    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentProfile = null;

    const headerEmail = document.getElementById("header-user-email");
    const accountName = document.getElementById("account-name");
    const badgeRole = document.getElementById("badge-role");
    const badgeAccountType = document.getElementById("badge-account-type");

    const navOverview = document.getElementById("nav-overview");
    const navUsers = document.getElementById("nav-users");
    const sectionOverview = document.getElementById("section-overview");
    const sectionUsers = document.getElementById("section-users");

    const usersIntro = document.getElementById("users-intro");
    const usersTableBody = document.getElementById("users-table-body");
    const usersListContainer = document.getElementById("users-list-container");
    const singleUserNote = document.getElementById("single-user-note");
    const addUserCard = document.getElementById("add-user-card");
    const addUserForm = document.getElementById("add-user-form");
    const addUserMsg = document.getElementById("add-user-message");

    function showSection(section) {
      if (section === "overview") {
        navOverview.classList.add("active");
        navUsers.classList.remove("active");
        sectionOverview.classList.remove("hidden");
        sectionUsers.classList.add("hidden");
      } else {
        navUsers.classList.add("active");
        navOverview.classList.remove("active");
        sectionUsers.classList.remove("hidden");
        sectionOverview.classList.add("hidden");
      }
    }

    navOverview.addEventListener("click", () => showSection("overview"));
    navUsers.addEventListener("click", () => showSection("users"));

    document.getElementById("btn-signout").addEventListener("click", async () => {
      await client.auth.signOut();
      window.location.href = "signin.html";
    });

    function setAddUserMessage(text, type) {
      addUserMsg.textContent = text || "";
      addUserMsg.className = "";
      if (type === "error") addUserMsg.classList.add("error");
      if (type === "success") addUserMsg.classList.add("success");
    }

    // INITIAL LOAD
    (async () => {
      const { data: sessionData } = await client.auth.getSession();
      if (!sessionData?.session) {
        window.location.href = "signin.html";
        return;
      }

      const user = sessionData.session.user;
      headerEmail.textContent = user.email;

      // TRY LOAD PROFILE
      let { data: profile, error: profileError } = await client
        .from("users")
        .select("*")
        .eq("id", user.id)
        .single();

      if (!profile || profileError) {
        // CREATE DEFAULT PROFILE
        profile = {
          id: user.id,
          email: user.email,
          full_name: user.user_metadata?.full_name || user.email,
          role: "admin",
          account_type: "single_user",
          business_owner_id: user.id
        };

        await client.from("users").upsert(profile, { onConflict: "id" });
      }

      currentProfile = profile;

      // FILL ACCOUNT CARD
      accountName.textContent = profile.full_name;
      badgeRole.textContent = profile.role;
      badgeRole.classList.add(profile.role);

      badgeAccountType.textContent =
        profile.account_type === "business"
          ? "Business account"
          : "Single user";
      badgeAccountType.classList.add(profile.account_type);

      // CONFIGURE USERS SECTION
      if (profile.account_type === "single_user") {
        usersIntro.textContent = "This is a single-user account.";
        singleUserNote.classList.remove("hidden");
        addUserCard.classList.add("hidden");
      } else if (profile.role !== "admin") {
        usersIntro.textContent = "Only administrators can add users.";
        addUserCard.classList.add("hidden");
      } else {
        usersIntro.textContent = "Manage users for this business.";
        addUserCard.classList.remove("hidden");
      }

      // LOAD BUSINESS USERS
      const businessOwnerId = profile.business_owner_id || profile.id;

      const { data: users } = await client
        .from("users")
        .select("*")
        .eq("business_owner_id", businessOwnerId)
        .order("created_at", { ascending: true });

      if (users?.length) {
        usersListContainer.classList.remove("hidden");
        usersTableBody.innerHTML = "";

        users.forEach(u => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${u.email}</td>
            <td>${u.full_name || ""}</td>
            <td>${u.role}</td>
            <td>${u.created_at ? new Date(u.created_at).toLocaleString() : ""}</td>
          `;
          usersTableBody.appendChild(tr);
        });
      }
    })();

    // ADD USER HANDLER
    addUserForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      setAddUserMessage("");

      if (currentProfile.account_type !== "business" || currentProfile.role !== "admin") {
        setAddUserMessage("You are not allowed to add users.", "error");
        return;
      }

      const fullName = document.getElementById("new-user-name").value.trim();
      const email = document.getElementById("new-user-email").value.trim();
      const password = document.getElementById("new-user-password").value;
      const passwordConfirm = document.getElementById("new-user-password-confirm").value;

      if (password !== passwordConfirm) {
        setAddUserMessage("Passwords do not match.", "error");
        return;
      }

      // Use separate client to avoid overwriting current session
      const transient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: false }
      });

      // CREATE AUTH USER
      const { data: newUserData, error: newUserError } = await transient.auth.signUp({
        email,
        password,
        options: { data: { full_name: fullName } }
      });

      if (newUserError) {
        setAddUserMessage(newUserError.message, "error");
        return;
      }

      const newUser = newUserData.user;

      // UPDATE PROFILE ROW
      const { error: upsertError } = await client
        .from("users")
        .upsert({
          id: newUser.id,
          email,
          full_name: fullName,
          role: "standard",
          account_type: "business",
          business_owner_id: currentProfile.business_owner_id
        });

      if (upsertError) {
        setAddUserMessage(upsertError.message, "error");
        return;
      }

      setAddUserMessage("User created successfully.", "success");
      setTimeout(() => window.location.reload(), 800);
    });
  </script>

</body>
</html>
