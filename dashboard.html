<!doctype html>
<html lang="en">
<head>
  <script>
    (function () {
      if (location.protocol === "http:") {
        location.replace("https://" + location.host + location.pathname + location.search + location.hash);
      }
    })();
  </script>

  <meta charset="utf-8" />
  <title>Warehouse Intelligence – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --wi-red: #dc2626;
      --wi-red-dark: #b91c1c;
      --bg: #f3f4f6;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
      font-family: system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    header {
      background: #ffffff;
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .brand {
      font-size: 1.2rem;
      font-weight: 700;
    }
    .brand span { color: var(--wi-red); }
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #header-user-email {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    #btn-signout {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 0.85rem;
    }
    #btn-signout:hover { background: #f9fafb; }

    /* LAYOUT */
    main { flex: 1; }
    .layout {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 12px 10px;
      height: fit-content;
    }
    .sidebar-section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .nav-item {
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    .nav-item.active {
      background: #fee2e2;
      color: #991b1b;
      font-weight: 600;
    }
    .nav-item:hover { background: #f3f4f6; }

    .sidebar-divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    /* Dropdown headers (Setup / Tools / Settings) */
    .dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 6px 2px;
      border-radius: 6px;
    }
    .dropdown-header:hover { background: #f3f4f6; }
    .dropdown-arrow { font-size: 0.8rem; color: var(--text-muted); }

    /* Dropdown items */
    .tool-item,
    .settings-item,
    .setup-item {
      display: block;
      padding: 6px 10px;
      border-radius: 6px;
      color: var(--text-main);
      text-decoration: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .tool-item:hover,
    .settings-item:hover,
    .setup-item:hover { background: #f3f4f6; }

    .settings-item.active {
      background: #fee2e2;
      color: #991b1b;
      font-weight: 600;
    }

    /* MAIN CONTENT */
    .content { flex: 1; }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.04);
    }
    h2 { margin: 0 0 10px; }
    h3 { margin: 0 0 8px; }
    .muted { color: var(--text-muted); font-size: 0.9rem; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      margin-right: 6px;
    }
    .badge.admin { background: #fee2e2; border-color: #fecaca; color: #991b1b; }
    .badge.standard { background: #eff6ff; border-color: #bfdbfe; color: #1d4ed8; }
    .badge.business { background: #dcfce7; border-color: #bbf7d0; color: #166534; }
    .badge.single_user { background: #f3e8ff; border-color: #e9d5ff; color: #6b21a8; }

    .account-id {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
    }

    /* TABLE */
    table { width: 100%; border-collapse: collapse; }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 4px;
      text-align: left;
      font-size: 0.9rem;
      vertical-align: top;
    }
    th { font-weight: 500; color: var(--text-muted); }

    /* FORMS & BUTTONS */
    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--text-main);
    }
    input {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    input:focus {
      outline: none;
      border-color: var(--wi-red);
      box-shadow: 0 0 0 1px rgba(220,38,38,0.1);
    }

    .btn-small {
      padding: 7px 12px;
      border-radius: 999px;
      background: #16a34a;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .btn-small:hover { background: #15803d; }

    .btn-reset {
      background: #6366f1;
      padding: 5px 9px;
      border-radius: 8px;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      margin-right: 4px;
    }
    .btn-reset:hover { background: #4f46e5; }

    .btn-promote {
      background: #f97316;
      padding: 5px 9px;
      border-radius: 8px;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      margin-right: 4px;
    }
    .btn-promote:hover { background: #ea580c; }

    .btn-delete {
      background: #b91c1c;
      padding: 5px 9px;
      border-radius: 8px;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .btn-delete:hover { background: #991b1b; }

    .btn-primary {
      padding: 9px 14px;
      border-radius: 999px;
      background: var(--wi-red);
      color: #fff;
      border: none;
      display: inline-block;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      text-decoration: none;
    }
    .btn-primary:hover { background: var(--wi-red-dark); }

    .error { color: #b91c1c; font-size: 0.8rem; margin-top: 6px; }
    .success { color: #166534; font-size: 0.8rem; margin-top: 6px; }
    .hidden { display: none; }

    /* Upgrade card styling */
    .upgrade-card {
      margin-top: 14px;
      border-style: dashed;
    }

    /* Alerts */
    .pill-red {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #fecaca;
      background:#fee2e2;
      color:#991b1b;
      font-size: .75rem;
      font-weight: 600;
    }
    .pill-dark {
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.2);
      background:#7f1d1d;
      color:#fff;
      font-size: .75rem;
      font-weight: 600;
    }
    .row-overdue td{
      background:#7f1d1d;
      color:#fff;
      border-bottom-color: rgba(255,255,255,.12);
    }
    .row-soon td{
      background:#fff7f7;
    }

    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      .sidebar { width: 100%; }
    }
  </style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="brand">Warehouse <span>Intelligence</span></div>
    <div class="user-info">
      <span id="header-user-email"></span>
      <button id="btn-signout">Sign out</button>
    </div>
  </div>
</header>

<main>
  <div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-section-title">Navigation</div>
      <div id="nav-overview" class="nav-item active">Overview</div>

      <div class="sidebar-divider"></div>

      <!-- Setup dropdown (NEW) -->
      <div class="dropdown-header" id="setup-toggle">
        <span class="sidebar-section-title" style="margin-bottom:0;">Setup</span>
        <span class="dropdown-arrow" id="setup-arrow">▾</span>
      </div>
      <div id="sidebar-setup-list" class="hidden">
        <a href="master-data.html" class="setup-item">Company &amp; site setup</a>
        <a href="mhe-setup.html" class="setup-item">MHE setup</a>
        <a href="storage-connect.html" class="setup-item">Connections</a>
      </div>

      <div class="sidebar-divider"></div>

      <!-- Tools dropdown -->
      <div class="dropdown-header" id="tools-toggle">
        <span class="sidebar-section-title" style="margin-bottom:0;">Tools</span>
        <span class="dropdown-arrow" id="tools-arrow">▾</span>
      </div>
      <div id="sidebar-tools-list">
        <a href="warehouse_scheduling.html" class="tool-item">Scheduling tool</a>
      </div>

      <div class="sidebar-divider"></div>

      <!-- Settings dropdown -->
      <div class="dropdown-header" id="settings-toggle">
        <span class="sidebar-section-title" style="margin-bottom:0;">Settings</span>
        <span class="dropdown-arrow" id="settings-arrow">▾</span>
      </div>
      <div id="sidebar-settings-list">
        <div id="set-users" class="settings-item">Users</div>
        <div id="set-password" class="settings-item">Password reset</div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <section class="content">

      <!-- ACCOUNT -->
      <div class="card">
        <h2>Account</h2>
        <div class="muted" id="account-name"></div>
        <div style="margin-top:6px;">
          <span id="badge-role" class="badge"></span>
          <span id="badge-account-type" class="badge"></span>
        </div>
        <div class="muted" style="margin-top:6px;">
          Account ID: <span id="account-id" class="account-id"></span>
        </div>
        <div class="muted" style="margin-top:6px;">
          All users and tools are scoped to this account.
        </div>
      </div>

      <!-- OVERVIEW -->
      <section id="section-overview">

        <!-- Equipment alerts (NEW) -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
            <div>
              <h2 style="margin-bottom:6px;">Equipment alerts</h2>
              <div class="muted">
                Overdue and due within 30 days (earliest of Inspection / LOLER / Service / PUWER).
              </div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <button id="btn-alerts-reload" class="btn-primary" style="padding:8px 12px;font-size:.85rem;">Reload</button>
              <a class="btn-primary" style="padding:8px 12px;font-size:.85rem;" href="mhe-setup.html">Open MHE setup</a>
            </div>
          </div>

          <div id="alerts-empty" class="muted" style="margin-top:10px;">Loading…</div>

          <div style="margin-top:10px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Site</th>
                  <th>Asset tag</th>
                  <th>Type</th>
                  <th>Next due</th>
                  <th>Due date</th>
                  <th>Days</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="alerts-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Scheduling tool card (existing) -->
        <div class="card">
          <h2>Scheduling tool</h2>
          <p class="muted">
            Plan MHE and labour, track indirect time, and compare plan vs actual by shift.
          </p>
          <a href="warehouse_scheduling.html" class="btn-primary">Open scheduling tool</a>
        </div>
      </section>

      <!-- USERS (restored inside dashboard) -->
      <section id="section-users" class="hidden">
        <div class="card">
          <h2>Users</h2>
          <p class="muted" id="users-intro"></p>

          <div id="users-list-container" class="hidden">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="users-table-body"></tbody>
            </table>
          </div>

          <div id="single-user-note" class="hidden">
            <p class="muted">
              This account is configured as <strong>Single user</strong>. Additional users cannot be added.
            </p>
          </div>

          <div id="upgrade-account-card" class="card upgrade-card hidden">
            <h3>Upgrade your account</h3>
            <p class="muted">
              You are currently using a single-user plan. Upgrade to enable multiple users,
              admin controls and additional features.
            </p>
            <button id="btn-upgrade-account" class="btn-primary">
              Upgrade account
            </button>
          </div>

          <div id="add-user-card" class="hidden" style="margin-top:14px;">
            <h3>Add a standard user</h3>
            <form id="add-user-form" style="margin-top:8px;">
              <label>Full name</label>
              <input id="new-user-name" required />

              <label>Email</label>
              <input id="new-user-email" type="email" required />

              <label>Password</label>
              <input id="new-user-password" type="password" required />

              <label>Confirm password</label>
              <input id="new-user-password-confirm" type="password" required />

              <button class="btn-small" type="submit">Create user</button>
            </form>
            <div id="add-user-message"></div>
          </div>
        </div>
      </section>

      <!-- PASSWORD RESET (restored inside dashboard) -->
      <section id="section-password" class="hidden">
        <div class="card">
          <h2>Password reset</h2>

          <h3 style="margin-top:10px;">Change your password</h3>
          <p class="muted">
            This updates the password for your own user only.
          </p>

          <form id="password-form" style="margin-top:10px;">
            <label>New password</label>
            <input id="password-new" type="password" required />

            <label>Confirm new password</label>
            <input id="password-new-confirm" type="password" required />

            <button class="btn-small" type="submit">Update password</button>
          </form>
          <div id="password-message"></div>
        </div>

        <div class="card hidden" id="admin-reset-card">
          <h3>Admin: send a password reset email</h3>
          <p class="muted">
            This sends a reset link to the email address. If the user exists, they will receive an email.
          </p>

          <form id="admin-reset-form" style="margin-top:10px;">
            <label>User email</label>
            <input id="admin-reset-email" type="email" placeholder="name@company.com" required />
            <button class="btn-small" type="submit">Send reset email</button>
          </form>
          <div id="admin-reset-message"></div>
        </div>
      </section>

    </section>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lwsddsbizqwsdmrcgnwm.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_otgRLtgXtaZgj-c2pxov1A_SQBpaxVB";

const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentProfile = null;

/* ELEMENTS */
const headerEmail = document.getElementById("header-user-email");
const btnSignout = document.getElementById("btn-signout");

/* Sidebar */
const navOverview = document.getElementById("nav-overview");

/* Setup dropdown */
const setupToggle = document.getElementById("setup-toggle");
const setupArrow = document.getElementById("setup-arrow");
const setupList = document.getElementById("sidebar-setup-list");

/* Tools dropdown */
const toolsToggle = document.getElementById("tools-toggle");
const toolsArrow = document.getElementById("tools-arrow");
const toolsList = document.getElementById("sidebar-tools-list");

/* Settings dropdown */
const settingsToggle = document.getElementById("settings-toggle");
const settingsArrow = document.getElementById("settings-arrow");
const settingsList = document.getElementById("sidebar-settings-list");

const setUsers = document.getElementById("set-users");
const setPassword = document.getElementById("set-password");

/* Sections */
const sectionOverview = document.getElementById("section-overview");
const sectionUsers = document.getElementById("section-users");
const sectionPassword = document.getElementById("section-password");

/* Account card */
const accountName = document.getElementById("account-name");
const badgeRole = document.getElementById("badge-role");
const badgeAccountType = document.getElementById("badge-account-type");
const accountIdSpan = document.getElementById("account-id");

/* Users */
const usersIntro = document.getElementById("users-intro");
const usersTableBody = document.getElementById("users-table-body");
const usersListContainer = document.getElementById("users-list-container");
const singleUserNote = document.getElementById("single-user-note");
const addUserCard = document.getElementById("add-user-card");
const addUserForm = document.getElementById("add-user-form");
const addUserMsg = document.getElementById("add-user-message");
const upgradeAccountCard = document.getElementById("upgrade-account-card");
const btnUpgradeAccount = document.getElementById("btn-upgrade-account");

/* Password */
const passwordForm = document.getElementById("password-form");
const passwordMsg = document.getElementById("password-message");
const adminResetCard = document.getElementById("admin-reset-card");
const adminResetForm = document.getElementById("admin-reset-form");
const adminResetEmail = document.getElementById("admin-reset-email");
const adminResetMsg = document.getElementById("admin-reset-message");

/* Alerts */
const alertsReload = document.getElementById("btn-alerts-reload");
const alertsEmpty = document.getElementById("alerts-empty");
const alertsTbody = document.getElementById("alerts-tbody");

/* HELPERS */
function clearActiveSidebar() {
  navOverview.classList.remove("active");
  [setUsers, setPassword].forEach(el => el.classList.remove("active"));
}
function hideAllSections() {
  sectionOverview.classList.add("hidden");
  sectionUsers.classList.add("hidden");
  sectionPassword.classList.add("hidden");
}
function showSection(section) {
  clearActiveSidebar();
  hideAllSections();

  if (section === "overview") {
    navOverview.classList.add("active");
    sectionOverview.classList.remove("hidden");
    return;
  }
  if (section === "users") {
    setUsers.classList.add("active");
    sectionUsers.classList.remove("hidden");
    return;
  }
  if (section === "password") {
    setPassword.classList.add("active");
    sectionPassword.classList.remove("hidden");
    return;
  }
}

/* NAV EVENTS */
navOverview.addEventListener("click", () => showSection("overview"));
setUsers.addEventListener("click", () => showSection("users"));
setPassword.addEventListener("click", () => showSection("password"));

/* DROPDOWNS */
let setupExpanded = false; // closed by default
setupList.classList.toggle("hidden", !setupExpanded);
setupArrow.textContent = setupExpanded ? "▾" : "▸";
setupToggle.addEventListener("click", () => {
  setupExpanded = !setupExpanded;
  setupList.classList.toggle("hidden", !setupExpanded);
  setupArrow.textContent = setupExpanded ? "▾" : "▸";
});

let toolsExpanded = true;
toolsToggle.addEventListener("click", () => {
  toolsExpanded = !toolsExpanded;
  toolsList.classList.toggle("hidden", !toolsExpanded);
  toolsArrow.textContent = toolsExpanded ? "▾" : "▸";
});

let settingsExpanded = true;
settingsToggle.addEventListener("click", () => {
  settingsExpanded = !settingsExpanded;
  settingsList.classList.toggle("hidden", !settingsExpanded);
  settingsArrow.textContent = settingsExpanded ? "▾" : "▸";
});

/* SIGN OUT */
btnSignout.addEventListener("click", async () => {
  await client.auth.signOut();
  window.location.href = "signin.html";
});

/* Message helpers */
function setAddUserMessage(text, type) {
  addUserMsg.textContent = text || "";
  addUserMsg.className = type || "";
}
function setPasswordMessage(text, type) {
  passwordMsg.textContent = text || "";
  passwordMsg.className = type || "";
}
function setAdminResetMessage(text, type) {
  adminResetMsg.textContent = text || "";
  adminResetMsg.className = type || "";
}

/* Date helpers for alerts */
function startOfToday(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
function parseYMD(ymd){ if(!ymd) return null; const d=new Date(ymd+"T00:00:00"); return isNaN(d)?null:d; }
function daysUntil(ymd){
  const d=parseYMD(ymd); if(!d) return null;
  return Math.floor((d.getTime()-startOfToday().getTime())/(1000*60*60*24));
}
function nextDueReason(asset){
  const options = [
    { label: "Inspection", ymd: asset.next_inspection_due },
    { label: "LOLER",      ymd: asset.next_loler_due },
    { label: "Service",    ymd: asset.next_service_due },
    { label: "PUWER",      ymd: asset.next_puwer_due }
  ].map(x => ({...x, date: parseYMD(x.ymd)})).filter(x => x.date);

  if (!options.length) return { label: "No dates", ymd: null, date: null, days: null };

  options.sort((a,b)=>a.date.getTime()-b.date.getTime());
  const top = options[0];
  return { label: top.label, ymd: top.ymd, date: top.date, days: daysUntil(top.ymd) };
}

async function loadAlerts(){
  alertsEmpty.textContent = "Loading…";
  alertsTbody.innerHTML = "";

  const [{ data: companies, error: ec }, { data: sites, error: es }, { data: types, error: et }] = await Promise.all([
    client.from("companies").select("id, name"),
    client.from("sites").select("id, company_id, name, code"),
    client.from("mhe_types").select("id, type_name"),
  ]);
  if (ec) throw ec;
  if (es) throw es;
  if (et) throw et;

  const { data: assets, error: ea } = await client
    .from("mhe_assets")
    .select("id, site_id, mhe_type_id, asset_tag, serial_number, status, next_inspection_due, next_loler_due, next_service_due, next_puwer_due");
  if (ea) throw ea;

  const safe = (v) => (v === null || v === undefined) ? "" : String(v);

  const rows = (assets || []).map(a => {
    const due = nextDueReason(a);
    const site = (sites || []).find(s => s.id === a.site_id);
    const comp = (companies || []).find(c => c.id === site?.company_id);
    const type = (types || []).find(t => t.id === a.mhe_type_id);

    const siteLabel = `${safe(comp?.name)} – ${safe(site?.name)}${site?.code ? " ("+safe(site.code)+")" : ""}`;
    const assetLabel = a.asset_tag || a.serial_number || "—";

    let bucket = 3; // 0 overdue, 1 due soon, 2 ok, 3 no dates
    let key = Number.POSITIVE_INFINITY;

    if (due.date){ key = due.date.getTime(); bucket = 2; }
    if (due.days !== null && due.days < 0){ bucket = 0; }
    else if (due.days !== null && due.days < 30){ bucket = 1; }

    return {
      _bucket: bucket,
      _key: key,
      siteLabel,
      assetLabel,
      typeLabel: safe(type?.type_name) || "—",
      reason: due.label,
      dueYmd: due.ymd,
      days: due.days,
      status: a.status || "—"
    };
  })
  .filter(r => r._bucket === 0 || r._bucket === 1)
  .sort((a,b) => (a._bucket - b._bucket) || (a._key - b._key));

  if (!rows.length){
    alertsEmpty.textContent = "No items due within 30 days. Good position.";
    return;
  }

  alertsEmpty.textContent = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    const isOverdue = r._bucket === 0;
    const isSoon = r._bucket === 1;

    if (isOverdue) tr.className = "row-overdue";
    if (isSoon) tr.className = "row-soon";

    const daysText = (r.days === null) ? "—" : (r.days < 0 ? `${Math.abs(r.days)} overdue` : `${r.days} days`);
    const pill = isOverdue
      ? `<span class="pill-dark">${r.reason}</span>`
      : `<span class="pill-red">${r.reason}</span>`;

    tr.innerHTML = `
      <td>${r.siteLabel}</td>
      <td>${safe(r.assetLabel)}</td>
      <td>${r.typeLabel}</td>
      <td>${pill}</td>
      <td>${r.dueYmd ? safe(r.dueYmd) : "—"}</td>
      <td>${safe(daysText)}</td>
      <td>${safe(r.status)}</td>
    `;
    alertsTbody.appendChild(tr);
  });
}

/* Alerts reload */
alertsReload.addEventListener("click", async () => {
  try { await loadAlerts(); } catch(e){ console.error(e); alertsEmpty.textContent = "Unable to load alerts."; }
});

/* INITIAL LOAD */
(async () => {
  const { data: sessionData } = await client.auth.getSession();
  if (!sessionData?.session) {
    window.location.href = "signin.html";
    return;
  }

  const authUser = sessionData.session.user;
  headerEmail.textContent = authUser.email;

  // Load profile
  let { data: profile } = await client
    .from("users")
    .select("*")
    .eq("id", authUser.id)
    .single();

  if (!profile) {
    profile = {
      id: authUser.id,
      email: authUser.email,
      full_name: authUser.user_metadata?.full_name || authUser.email,
      role: "admin",
      account_type: "single_user",
      business_owner_id: authUser.id,
      is_active: true
    };
    await client.from("users").upsert(profile);
  }

  if (profile.is_active === false) {
    alert("This user has been deactivated. Please contact your administrator.");
    await client.auth.signOut();
    window.location.href = "signin.html";
    return;
  }

  currentProfile = profile;

  // Account card
  accountName.textContent = profile.full_name || profile.email || "";
  badgeRole.textContent = profile.role === "admin" ? "Admin" : "Standard";
  badgeRole.classList.add(profile.role === "admin" ? "admin" : "standard");

  badgeAccountType.textContent =
    profile.account_type === "business" ? "Business account" : "Single user";
  badgeAccountType.classList.add(profile.account_type);

  const rawId = profile.business_owner_id || profile.id;
  const shortId = "WI-" + rawId.slice(0, 8).toUpperCase();
  accountIdSpan.textContent = shortId;
  accountIdSpan.title = rawId;

  // Password reset: show admin card only for admins
  if (currentProfile.role === "admin") {
    adminResetCard.classList.remove("hidden");
  } else {
    adminResetCard.classList.add("hidden");
  }

  // Users section config + upgrade card visibility
  if (profile.account_type === "single_user") {
    usersIntro.textContent = "This is a single-user account.";
    singleUserNote.classList.remove("hidden");
    addUserCard.classList.add("hidden");
    upgradeAccountCard.classList.remove("hidden");
  } else if (profile.role !== "admin") {
    usersIntro.textContent =
      "You can view users in your business. Only admins can manage them.";
    singleUserNote.classList.add("hidden");
    addUserCard.classList.add("hidden");
    upgradeAccountCard.classList.add("hidden");
  } else {
    usersIntro.textContent = "Manage users under this business account.";
    singleUserNote.classList.add("hidden");
    addUserCard.classList.remove("hidden");
    upgradeAccountCard.classList.add("hidden");
  }

  // Load active users in business
  const businessOwnerId = profile.business_owner_id || profile.id;
  const { data: users } = await client
    .from("users")
    .select("*")
    .eq("business_owner_id", businessOwnerId)
    .eq("is_active", true)
    .order("created_at", { ascending: true });

  if (users?.length) {
    usersListContainer.classList.remove("hidden");
    usersTableBody.innerHTML = "";

    users.forEach(u => {
      const tr = document.createElement("tr");
      const canManage = currentProfile.role === "admin";
      const isSelf = u.id === currentProfile.id;

      let actionsHtml = "";
      if (canManage && !isSelf) {
        actionsHtml = `
          <button class="btn-reset" data-email="${u.email}">Reset</button>
          ${u.role !== "admin" ? `<button class="btn-promote" data-id="${u.id}">Promote</button>` : ""}
          <button class="btn-delete" data-id="${u.id}">Delete</button>
        `;
      }

      tr.innerHTML = `
        <td>${u.email}</td>
        <td>${u.full_name || ""}</td>
        <td>${u.role}</td>
        <td>${u.created_at ? new Date(u.created_at).toLocaleString() : ""}</td>
        <td>${actionsHtml}</td>
      `;

      usersTableBody.appendChild(tr);
    });

    // Attach admin-only actions
    if (currentProfile.role === "admin") {
      document.querySelectorAll(".btn-reset").forEach(btn => {
        btn.addEventListener("click", async () => {
          const email = btn.dataset.email;

          const { error } = await client.auth.resetPasswordForEmail(email, {
            redirectTo: "https://warehouseintelligence.co.uk/password-reset.html"
          });

          if (error) {
            console.error(error);
            alert("Unable to send reset email. Please try again.");
            return;
          }

          alert("If an account exists, a reset email has been sent to " + email);
        });
      });

      document.querySelectorAll(".btn-promote").forEach(btn => {
        btn.addEventListener("click", async () => {
          const userId = btn.dataset.id;
          if (!confirm("Promote this user to admin?")) return;
          const { error } = await client.from("users").update({ role: "admin" }).eq("id", userId);
          if (error) alert("Error promoting user: " + error.message);
          else window.location.reload();
        });
      });

      document.querySelectorAll(".btn-delete").forEach(btn => {
        btn.addEventListener("click", async () => {
          const userId = btn.dataset.id;
          if (!confirm("Delete this user? They will be deactivated and unable to access the account.")) return;
          const { error } = await client.from("users").update({ is_active: false }).eq("id", userId);
          if (error) alert("Error deleting user: " + error.message);
          else window.location.reload();
        });
      });
    }
  }

  // Load alerts into overview
  try { await loadAlerts(); } catch(e){ console.error(e); alertsEmpty.textContent = "Unable to load alerts."; }

  // Default section
  showSection("overview");
})();

/* ADD USER */
addUserForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  setAddUserMessage("", "");

  if (!currentProfile || currentProfile.account_type !== "business" || currentProfile.role !== "admin") {
    setAddUserMessage("You are not allowed to add users.", "error");
    return;
  }

  const fullName = document.getElementById("new-user-name").value.trim();
  const email = document.getElementById("new-user-email").value.trim();
  const password = document.getElementById("new-user-password").value;
  const confirmPw = document.getElementById("new-user-password-confirm").value;

  if (password !== confirmPw) {
    setAddUserMessage("Passwords do not match.", "error");
    return;
  }

  const transient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: false }
  });

  const { data, error } = await transient.auth.signUp({
    email,
    password,
    options: { data: { full_name: fullName } }
  });

  if (error) {
    setAddUserMessage(error.message, "error");
    return;
  }

  const newUser = data.user;

  const { error: upsertErr } = await client
    .from("users")
    .upsert({
      id: newUser.id,
      email,
      full_name: fullName,
      role: "standard",
      account_type: "business",
      business_owner_id: currentProfile.business_owner_id || currentProfile.id,
      is_active: true
    });

  if (upsertErr) {
    setAddUserMessage(upsertErr.message, "error");
    return;
  }

  setAddUserMessage("User created successfully.", "success");
  setTimeout(() => window.location.reload(), 800);
});

/* PASSWORD – CHANGE OWN */
passwordForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  setPasswordMessage("", "");

  const pw1 = document.getElementById("password-new").value;
  const pw2 = document.getElementById("password-new-confirm").value;

  if (pw1 !== pw2) {
    setPasswordMessage("Passwords do not match.", "error");
    return;
  }

  const { error } = await client.auth.updateUser({ password: pw1 });

  if (error) {
    setPasswordMessage(error.message, "error");
    return;
  }

  setPasswordMessage("Password updated. You may be asked to sign in again on other devices.", "success");
  passwordForm.reset();
});

/* ADMIN PASSWORD RESET */
if (adminResetForm) {
  adminResetForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    setAdminResetMessage("", "");

    if (!currentProfile || currentProfile.role !== "admin") {
      setAdminResetMessage("Admin access required.", "error");
      return;
    }

    const email = (adminResetEmail.value || "").trim();
    if (!email) {
      setAdminResetMessage("Please enter an email address.", "error");
      return;
    }

    const { error } = await client.auth.resetPasswordForEmail(email, {
      redirectTo: "https://warehouseintelligence.co.uk/password-reset.html"
    });

    if (error) {
      console.error(error);
      setAdminResetMessage("Unable to send reset email. Please try again.", "error");
      return;
    }

    setAdminResetMessage("If an account exists, a reset email has been sent to " + email + ".", "success");
    adminResetForm.reset();
  });
}

/* UPGRADE */
if (btnUpgradeAccount) {
  btnUpgradeAccount.addEventListener("click", () => {
    window.location.href = "pricing.html";
  });
}
</script>

</body>
</html>
